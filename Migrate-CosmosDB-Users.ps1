# ?? COSMOS DB CONTAINER MIGRATION SCRIPT
# Transfers all users from old container to new container with correct partition key

param(
    [string]$OldContainerName = "Users",
    [string]$NewContainerName = "users",
    [switch]$DryRun = $false
)

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?         ?? COSMOS DB USERS CONTAINER MIGRATION                ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

Write-Host "`n?? MIGRATION PLAN:" -ForegroundColor Yellow
Write-Host "   Source: $OldContainerName (wrong partition key)" -ForegroundColor White
Write-Host "   Target: $NewContainerName (correct: /username)" -ForegroundColor White
Write-Host "   Mode: $(if ($DryRun) { 'DRY RUN (no changes)' } else { 'LIVE MIGRATION' })" -ForegroundColor $(if ($DryRun) { 'Yellow' } else { 'Red' })

if (-not $DryRun) {
    Write-Host "`n??  WARNING: This will migrate all users!" -ForegroundColor Yellow
    $confirm = Read-Host "`nType 'MIGRATE' to continue"
    
    if ($confirm -ne "MIGRATE") {
        Write-Host "`n? Migration cancelled" -ForegroundColor Red
        return
    }
}

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                     ?? LOADING ASSEMBLIES                      ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

try {
    # Load required assemblies
    Add-Type -Path "bin\Debug\net8.0-windows\Microsoft.Azure.Cosmos.dll"
    Add-Type -Path "bin\Debug\net8.0-windows\Newtonsoft.Json.dll"
    
    Write-Host "? Assemblies loaded" -ForegroundColor Green
}
catch {
    Write-Host "? Failed to load assemblies: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "`nMake sure the project is built first!" -ForegroundColor Yellow
    return
}

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                  ?? CONNECTING TO COSMOS DB                    ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

# Cosmos DB connection details
$endpoint = "https://fallen-collective.documents.azure.com:443/"
$key = "m3XmNlXeJo1eFKx0qkIQhd4CgB5P3xQbARjcdYQw18J1QfC22XLUCyEhZn7gBtfPSqPfH1KN2OuwACDbhbvMqQ=="
$databaseName = "DJBookingDB"

try {
    $cosmosClient = New-Object Microsoft.Azure.Cosmos.CosmosClient($endpoint, $key)
    $database = $cosmosClient.GetDatabase($databaseName)
    
    Write-Host "? Connected to Cosmos DB" -ForegroundColor Green
    Write-Host "   Database: $databaseName" -ForegroundColor White
}
catch {
    Write-Host "? Failed to connect: $($_.Exception.Message)" -ForegroundColor Red
    return
}

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?              ?? READING FROM OLD CONTAINER                     ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

try {
    $oldContainer = $database.GetContainer($OldContainerName)
    
    # Query all users
    $query = "SELECT * FROM c"
    $queryDefinition = New-Object Microsoft.Azure.Cosmos.QueryDefinition($query)
    
    $iterator = $oldContainer.GetItemQueryIterator($queryDefinition)
    $users = @()
    
    while ($iterator.HasMoreResults) {
        $response = $iterator.ReadNextAsync().GetAwaiter().GetResult()
        foreach ($user in $response) {
            $users += $user
        }
    }
    
    Write-Host "? Found $($users.Count) users to migrate" -ForegroundColor Green
    
    if ($users.Count -eq 0) {
        Write-Host "`n??  No users found in old container!" -ForegroundColor Yellow
        return
    }
    
    # Display users
    Write-Host "`n?? USERS TO MIGRATE:" -ForegroundColor Cyan
    foreach ($user in $users) {
        $username = $user.username
        if (-not $username) { $username = $user.Username }
        Write-Host "   • $username" -ForegroundColor White
    }
}
catch {
    Write-Host "? Failed to read old container: $($_.Exception.Message)" -ForegroundColor Red
    return
}

if ($DryRun) {
    Write-Host "`n? DRY RUN COMPLETE - No changes made" -ForegroundColor Green
    Write-Host "`nRun without -DryRun to perform actual migration" -ForegroundColor Yellow
    return
}

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?           ?? CREATING NEW CONTAINER (if needed)                ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

try {
    # Check if new container exists
    try {
        $newContainer = $database.GetContainer($NewContainerName)
        Write-Host "??  Container '$NewContainerName' already exists" -ForegroundColor Yellow
    }
    catch {
        Write-Host "Creating new container: $NewContainerName" -ForegroundColor Yellow
        
        # Create container with correct partition key
        $containerProperties = New-Object Microsoft.Azure.Cosmos.ContainerProperties
        $containerProperties.Id = $NewContainerName
        $containerProperties.PartitionKeyPath = "/username"  # lowercase!
        
        $throughput = New-Object Microsoft.Azure.Cosmos.ThroughputProperties
        $throughput = [Microsoft.Azure.Cosmos.ThroughputProperties]::CreateManualThroughput(400)
        
        $response = $database.CreateContainerAsync($containerProperties, $throughput).GetAwaiter().GetResult()
        $newContainer = $response.Container
        
        Write-Host "? Created new container with /username partition key" -ForegroundColor Green
    }
}
catch {
    Write-Host "? Failed to create container: $($_.Exception.Message)" -ForegroundColor Red
    return
}

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?              ?? MIGRATING USERS TO NEW CONTAINER               ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

$successCount = 0
$errorCount = 0

foreach ($user in $users) {
    $username = $user.username
    if (-not $username) { $username = $user.Username }
    
    try {
        Write-Host "   Migrating: $username..." -NoNewline -ForegroundColor Yellow
        
        # Ensure username field is lowercase
        if ($user.Username -and -not $user.username) {
            $user | Add-Member -NotePropertyName "username" -NotePropertyValue $user.Username -Force
        }
        
        # Create item in new container with correct partition key
        $partitionKey = New-Object Microsoft.Azure.Cosmos.PartitionKey($username)
        $response = $newContainer.CreateItemAsync($user, $partitionKey).GetAwaiter().GetResult()
        
        Write-Host " ? Success" -ForegroundColor Green
        $successCount++
    }
    catch {
        Write-Host " ? Failed: $($_.Exception.Message)" -ForegroundColor Red
        $errorCount++
    }
}

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?                     ? MIGRATION COMPLETE                       ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green

Write-Host "`n?? MIGRATION SUMMARY:" -ForegroundColor Cyan
Write-Host "   ? Migrated: $successCount users" -ForegroundColor Green
Write-Host "   ? Failed:   $errorCount users" -ForegroundColor $(if ($errorCount -eq 0) { 'Green' } else { 'Red' })
Write-Host "   ?? Total:    $($users.Count) users" -ForegroundColor White

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host "?                      ??  NEXT STEPS                             ?" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Yellow

Write-Host "`n1??  UPDATE CODE to use new container:" -ForegroundColor Cyan
Write-Host "   File: Services/CosmosDbService.cs" -ForegroundColor White
Write-Host "   Change: _usersContainer = database.GetContainer('users')" -ForegroundColor Yellow
Write-Host "           (lowercase 'users' instead of 'Users')" -ForegroundColor Yellow

Write-Host "`n2??  TEST user registration and login" -ForegroundColor Cyan

Write-Host "`n3??  DELETE OLD CONTAINER (after confirming everything works):" -ForegroundColor Cyan
Write-Host "   Azure Portal ? Cosmos DB ? DJBookingDB ? Users ? Delete" -ForegroundColor White

Write-Host "`n? DONE!" -ForegroundColor Green
Write-Host "`nAll users have been migrated to the new container!" -ForegroundColor White

# Cleanup
$cosmosClient.Dispose()
