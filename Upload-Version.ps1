# ?? UPLOAD TO HOSTINGER - AUTOMATIC VERSION MANAGEMENT
# Usage: .\Upload-Version.ps1 -Version "1.2.6"

param(
    [Parameter(Mandatory=$true)]
    [string]$Version,
    [string]$HostingerHost = "c40.radioboss.fm/u/98",
    [string]$HostingerPath = "public_html"
)

# ??????????????????????????????????????????????????????????????????????????????
# CONFIGURATION
# ??????????????????????????????????????????????????????????????????????????????

$OldVersionsPath = "$HostingerPath/OLD_VERSIONS"
$IndexFile = "$HostingerPath/index.html"

# ??????????????????????????????????????????????????????????????????????????????
# STEP 1: RELEASE NOTES - ALWAYS EDITABLE
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?          ?? EDIT RELEASE NOTES FOR v$Version" -NoNewline -ForegroundColor Cyan
Write-Host (" " * (46 - $Version.Length)) -NoNewline
Write-Host "?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

# Release notes template with current changes
$releaseNotesTemplate = @"
? What's New in v$Version

MAJOR FEATURES:
? Mandatory auto-playing tutorial with CandyBot voice narration
? Interactive UI highlighting with pink spotlight  
? 100% black overlay outside MainWindow
? Users panel pop-out maximizable window
? Tutorial checkbox for admin re-training

BUG FIXES:
? Fixed logout DialogResult error
? Fixed tutorial audio playback (absolute paths)
? Fixed element highlighting (added x:Name attributes)
? Fixed panel positioning (inside MainWindow, not taskbar)
? Fixed voice file paths (InteractiveGuide/Voices/)
? Fixed Cosmos DB partition key mismatch (JsonProperty attributes)

IMPROVEMENTS:
? Tutorial cannot be skipped (mandatory completion)
? Tutorial cannot be closed early
? Auto-advances when voice finishes
? 1 second pause between steps
? Fallback timers for missing audio files
? Proper JSON serialization for all User properties

[ADD MORE CHANGES ABOVE IF NEEDED]
"@

$tempNotesFile = "$env:TEMP\release-notes-v$Version.txt"
$releaseNotesTemplate | Out-File -FilePath $tempNotesFile -Encoding UTF8

Write-Host "`nNotepad will open with release notes..." -ForegroundColor Yellow
Write-Host "Edit the notes, SAVE, and CLOSE Notepad to continue.`n" -ForegroundColor Yellow

Start-Process notepad $tempNotesFile -Wait

# Read edited notes
$releaseNotes = Get-Content $tempNotesFile -Raw

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?                    ? RELEASE NOTES PREVIEW                    ?" -ForegroundColor Green  
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host $releaseNotes -ForegroundColor White

# ??????????????????????????????????????????????????????????????????????????????
# STEP 2: CONFIRM UPLOAD
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host "?                   ??  CONFIRM UPLOAD TO HOSTINGER              ?" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Yellow

Write-Host "`nThis will:" -ForegroundColor White
Write-Host "  1. Build Release version v$Version" -ForegroundColor Cyan
Write-Host "  2. Create ZIP package" -ForegroundColor Cyan
Write-Host "  3. Update update-info.json" -ForegroundColor Cyan
Write-Host "  4. Create index.html for Hostinger" -ForegroundColor Cyan
Write-Host "  5. Prepare all files for upload" -ForegroundColor Cyan

$confirm = Read-Host "`nType 'UPLOAD' to continue"

if ($confirm -ne "UPLOAD") {
    Write-Host "`n? Upload cancelled" -ForegroundColor Red
    Remove-Item $tempNotesFile -Force
    return
}

# ??????????????????????????????????????????????????????????????????????????????
# STEP 3: BUILD RELEASE
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                      ?? BUILDING RELEASE v$Version" -NoNewline -ForegroundColor Cyan
Write-Host (" " * (30 - $Version.Length)) -NoNewline
Write-Host "?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

dotnet publish -c Release --self-contained false -r win-x64

if ($LASTEXITCODE -ne 0) {
    Write-Host "`n? BUILD FAILED!" -ForegroundColor Red
    Remove-Item $tempNotesFile -Force
    return
}

Write-Host "`n? Build successful!" -ForegroundColor Green

# ??????????????????????????????????????????????????????????????????????????????
# STEP 4: CREATE ZIP PACKAGE
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                    ?? CREATING ZIP PACKAGE                     ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

$publishPath = "bin\Release\net8.0-windows\win-x64\publish"
Push-Location $publishPath

if (Test-Path "DJBookingSystem-Full-v$Version.zip") {
    Remove-Item "DJBookingSystem-Full-v$Version.zip" -Force
}

Compress-Archive -Path * -DestinationPath "DJBookingSystem-Full-v$Version.zip" -Force

Write-Host "`n? Created: DJBookingSystem-Full-v$Version.zip" -ForegroundColor Green

Pop-Location

# ??????????????????????????????????????????????????????????????????????????????
# STEP 5: UPDATE update-info.json
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                  ?? UPDATING update-info.json                  ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

$updateInfo = @{
    version = $Version
    releaseDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
    downloadUrl = "https://$HostingerHost/DJBookingSystem.exe"
    fullPackageUrl = "https://$HostingerHost/DJBookingSystem-Full-v$Version.zip"
    isCritical = $false
    releaseNotes = $releaseNotes
    minimumVersion = "1.0.0"
    fileSize = (Get-Item "$publishPath\DJBookingSystem.exe").Length
    sha256Hash = (Get-FileHash "$publishPath\DJBookingSystem.exe" -Algorithm SHA256).Hash
} | ConvertTo-Json -Depth 10

$updateInfo | Out-File -FilePath "update-info.json" -Encoding UTF8 -Force

Write-Host "? Updated: update-info.json" -ForegroundColor Green

# ??????????????????????????????????????????????????????????????????????????????
# STEP 6: UPDATE index.html (NOT download.html!)
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?              ?? UPDATING public_html/index.html                ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan

# Use download.html as template to create index.html
$htmlContent = Get-Content "download.html" -Raw

# Replace version number
$htmlContent = $htmlContent -replace 'Version \d+\.\d+\.\d+', "Version $Version"

# Replace full package ZIP link
$htmlContent = $htmlContent -replace 'DJBookingSystem-Full-v\d+\.\d+\.\d+\.zip', "DJBookingSystem-Full-v$Version.zip"

# Replace "What's New" section with actual release notes
$whatsnewPattern = '(<h3>.*What''s New in v[\d\.]+</h3>\s*<ul>)(.*?)(</ul>)'
$newWhatsNew = "<h3>? What's New in v$Version</h3>`n            <ul>`n"

# Convert release notes to HTML list items
$releaseNotes -split "`n" | Where-Object { $_ -match '?' } | ForEach-Object {
    $item = $_ -replace '?\s*', ''
    if ($item.Trim()) {
        $newWhatsNew += "                <li>? <strong>$item</strong></li>`n"
    }
}

$newWhatsNew += "            </ul>"
$htmlContent = $htmlContent -replace $whatsnewPattern, $newWhatsNew

# Save as index.html (for Hostinger upload)
$htmlContent | Out-File -FilePath "index.html" -Encoding UTF8 -Force

Write-Host "? Created: index.html (ready for Hostinger upload)" -ForegroundColor Green

# ??????????????????????????????????????????????????????????????????????????????
# STEP 7: DISPLAY UPLOAD INSTRUCTIONS
# ??????????????????????????????????????????????????????????????????????????????

Write-Host "`n??????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?              ? ALL FILES READY FOR HOSTINGER UPLOAD            ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green

Write-Host "`n?? FILES TO UPLOAD:" -ForegroundColor Cyan
Write-Host "   ? $publishPath\DJBookingSystem.exe" -ForegroundColor White
Write-Host "   ? $publishPath\DJBookingSystem-Full-v$Version.zip" -ForegroundColor White
Write-Host "   ? update-info.json" -ForegroundColor White
Write-Host "   ? index.html" -ForegroundColor White

Write-Host "`n?? HOSTINGER UPLOAD STEPS:" -ForegroundColor Yellow
Write-Host "?????????????????????????????????????????????????????????????" -ForegroundColor Yellow

Write-Host "`n1??  LOGIN TO HOSTINGER" -ForegroundColor Cyan
Write-Host "   - Go to: https://hpanel.hostinger.com" -ForegroundColor White
Write-Host "   - Or use SSH/FTP" -ForegroundColor White

Write-Host "`n2??  NAVIGATE TO: $HostingerPath/" -ForegroundColor Cyan

Write-Host "`n3??  BACKUP OLD VERSION TO OLD_VERSIONS/" -ForegroundColor Cyan
Write-Host "   Move these files:" -ForegroundColor White
Write-Host "   • DJBookingSystem.exe" -ForegroundColor Gray
Write-Host "     ? Move to: OLD_VERSIONS/DJBookingSystem-v[OLD-VERSION].exe" -ForegroundColor Yellow
Write-Host "   • DJBookingSystem-Full-v[OLD].zip" -ForegroundColor Gray  
Write-Host "     ? Move to: OLD_VERSIONS/" -ForegroundColor Yellow

Write-Host "`n4??  UPLOAD NEW FILES" -ForegroundColor Cyan
Write-Host "   Upload these to: public_html/" -ForegroundColor White
Write-Host "   ? DJBookingSystem.exe (same filename - overwrites)" -ForegroundColor Green
Write-Host "   ? DJBookingSystem-Full-v$Version.zip (new file)" -ForegroundColor Green
Write-Host "   ? update-info.json (overwrites)" -ForegroundColor Green
Write-Host "   ? index.html (overwrites)" -ForegroundColor Green

Write-Host "`n5??  VERIFY LINKS WORK:" -ForegroundColor Cyan
Write-Host "   https://$HostingerHost/index.html" -ForegroundColor Yellow
Write-Host "   https://$HostingerHost/DJBookingSystem.exe" -ForegroundColor Yellow
Write-Host "   https://$HostingerHost/update-info.json" -ForegroundColor Yellow
Write-Host "   https://$HostingerHost/DJBookingSystem-Full-v$Version.zip" -ForegroundColor Yellow

Write-Host "`n?????????????????????????????????????????????????????????????" -ForegroundColor Yellow

Write-Host "`n?? TIP: Keep OLD_VERSIONS for rollback if needed!" -ForegroundColor Cyan

Write-Host "`n?? VERSION $Version IS READY FOR DEPLOYMENT!" -ForegroundColor Green

# Cleanup
Remove-Item $tempNotesFile -Force
