# Update Server Setup Guide - Complete Implementation

## ?? Overview

Your DJ Booking System now checks for updates **every hour on the hour** with **forced automatic downloads** when updates are available.

### Update Check Schedule:
- ? **On Application Startup** (3 seconds after launch)
- ? **Every Hour on the Hour** (12:00, 1:00, 2:00, etc.)
- ? **Forced Download** - No cancel option, installs automatically

---

## ?? Server Setup Options

### **Option 1: Simple File Hosting (Easiest)**

Use any web server to host a JSON file and installer.

#### **Files Needed:**
1. `version.json` - Update metadata
2. `DJBookingSystem-{version}.exe` - Installer file

#### **Example Hosting Services:**
- ? **GitHub Pages** (Free)
- ? **Netlify** (Free)
- ? **AWS S3** (Cheap, reliable)
- ? **Azure Blob Storage** (Cheap, reliable)
- ? **Your own web server**

---

### **Option 2: API Endpoint (Recommended)**

Create a simple API that returns update information.

#### **Endpoint**: `https://djbookupdates.com/api/updates/check`

#### **Response Format** (JSON):
```json
{
  "updateAvailable": true,
  "currentVersion": "1.0.0",
  "latestVersion": "1.2.0",
  "releaseDate": "2025-01-15T10:00:00Z",
  "downloadUrl": "https://djbookupdates.com/updates/DJBookingSystem-1.2.0.exe",
  "releaseNotes": "New features and bug fixes",
  "changelogUrl": "https://djbookupdates.com/changelog.html",
  "features": [
    "Discord chat integration with auto-login",
    "Hourly automatic update checks",
    "Improved UI and performance"
  ],
  "bugFixes": [
    "Fixed WebView2 initialization error",
    "Fixed online status tracking",
    "Fixed auto-login issues"
  ],
  "isCritical": true,
  "minimumVersion": "1.0.0",
  "isSecureConnection": true
}
```

---

## ?? Setup Instructions

### **Step 1: Choose Your Server**

#### **A. Using GitHub Pages (FREE & EASY)**

1. **Create GitHub Repository:**
```bash
mkdir djbooking-updates
cd djbooking-updates
git init
```

2. **Create `version.json`:**
```json
{
  "updateAvailable": true,
  "latestVersion": "1.2.0",
  "releaseDate": "2025-01-15T10:00:00Z",
  "downloadUrl": "https://yourusername.github.io/djbooking-updates/DJBookingSystem-1.2.0.exe",
  "releaseNotes": "Update with new features",
  "features": ["New Discord chat", "Hourly updates"],
  "bugFixes": ["Fixed initialization errors"],
  "isCritical": true
}
```

3. **Upload Installer:**
```bash
# Add your installer file
cp /path/to/DJBookingSystem-1.2.0.exe ./
git add .
git commit -m "Add version 1.2.0"
git push origin main
```

4. **Enable GitHub Pages:**
- Go to repository Settings ? Pages
- Source: Deploy from main branch
- Your URL: `https://yourusername.github.io/djbooking-updates/`

5. **Update Client URL:**
In `Services\SecureUpdateClient.cs`:
```csharp
private const string UPDATE_SERVER_URL = "https://yourusername.github.io/djbooking-updates";
private const string UPDATE_CHECK_ENDPOINT = "/version.json";
```

---

#### **B. Using AWS S3 (CHEAP & RELIABLE)**

1. **Create S3 Bucket:**
```bash
aws s3 mb s3://djbooking-updates
```

2. **Upload Files:**
```bash
aws s3 cp version.json s3://djbooking-updates/version.json --acl public-read
aws s3 cp DJBookingSystem-1.2.0.exe s3://djbooking-updates/updates/ --acl public-read
```

3. **Enable Static Website Hosting:**
```bash
aws s3 website s3://djbooking-updates --index-document version.json
```

4. **Your URL:**
```
https://djbooking-updates.s3.amazonaws.com/version.json
```

---

#### **C. Using Azure Blob Storage**

1. **Create Storage Account:**
```powershell
az storage account create --name djbookupdates --resource-group YourResourceGroup
```

2. **Create Container:**
```powershell
az storage container create --name updates --public-access blob
```

3. **Upload Files:**
```powershell
az storage blob upload --file version.json --container updates --name version.json
az storage blob upload --file DJBookingSystem-1.2.0.exe --container updates --name updates/DJBookingSystem-1.2.0.exe
```

4. **Your URL:**
```
https://djbookupdates.blob.core.windows.net/updates/version.json
```

---

### **Step 2: Create API Endpoint (Optional but Recommended)**

#### **Simple Node.js API:**

```javascript
// server.js
const express = require('express');
const app = express();

app.get('/api/updates/check', (req, res) => {
  const currentVersion = req.headers['x-client-version'] || '1.0.0';
  const latestVersion = '1.2.0';
  
  res.json({
    updateAvailable: currentVersion !== latestVersion,
    currentVersion: currentVersion,
    latestVersion: latestVersion,
    releaseDate: new Date().toISOString(),
    downloadUrl: 'https://djbookupdates.com/updates/DJBookingSystem-1.2.0.exe',
    releaseNotes: 'New features and improvements',
    features: [
      'Discord chat with auto-login',
      'Hourly automatic updates',
      'Improved performance'
    ],
    bugFixes: [
      'Fixed initialization errors',
      'Fixed status tracking'
    ],
    isCritical: true,
    minimumVersion: '1.0.0',
    isSecureConnection: true
  });
});

app.listen(3000, () => {
  console.log('Update server running on port 3000');
});
```

#### **Deploy to Heroku (Free):**
```bash
git init
git add .
git commit -m "Update server"
heroku create djbooking-updates
git push heroku main
```

Your API: `https://djbooking-updates.herokuapp.com/api/updates/check`

---

### **Step 3: Update Client Configuration**

In `Services\SecureUpdateClient.cs`:

```csharp
// Update server configuration
private const string UPDATE_SERVER_URL = "https://djbookupdates.com";
private const string UPDATE_CHECK_ENDPOINT = "/api/updates/check";
private const string UPDATE_DOWNLOAD_ENDPOINT = "/updates/";
```

**Change to your actual server:**
```csharp
private const string UPDATE_SERVER_URL = "https://yourusername.github.io/djbooking-updates";
// OR
private const string UPDATE_SERVER_URL = "https://djbookupdates.herokuapp.com";
```

---

### **Step 4: SSL Certificate Setup (Important!)**

For security, get certificate fingerprints:

```powershell
# Get certificate fingerprint
openssl s_client -connect djbookupdates.com:443 < /dev/null 2>/dev/null | openssl x509 -fingerprint -sha256 -noout
```

Update in `Services\SecureUpdateClient.cs`:
```csharp
private static readonly string[] TRUSTED_FINGERPRINTS = new[]
{
    "AA:BB:CC:DD:EE:FF:00:11:22:33:44:55:66:77:88:99:AA:BB:CC:DD:EE:FF:00:11:22:33:44:55:66:77:88:99",
    "BACKUP_FINGERPRINT_HERE"
};
```

---

## ?? Deployment Workflow

### **When You Release a New Version:**

1. **Build New Installer:**
```bash
# Build your application
dotnet publish -c Release

# Create installer (example using Inno Setup)
iscc installer-script.iss

# Output: DJBookingSystem-1.2.0.exe
```

2. **Update version.json:**
```json
{
  "latestVersion": "1.2.0",
  "releaseDate": "2025-01-15T10:00:00Z",
  "downloadUrl": "https://djbookupdates.com/updates/DJBookingSystem-1.2.0.exe",
  "features": ["New feature 1", "New feature 2"],
  "bugFixes": ["Bug fix 1", "Bug fix 2"],
  "isCritical": true
}
```

3. **Upload to Server:**

**GitHub:**
```bash
git add .
git commit -m "Release v1.2.0"
git push
```

**AWS S3:**
```bash
aws s3 cp version.json s3://djbooking-updates/
aws s3 cp DJBookingSystem-1.2.0.exe s3://djbooking-updates/updates/
```

**Azure:**
```powershell
az storage blob upload --file version.json --container updates --name version.json --overwrite
az storage blob upload --file DJBookingSystem-1.2.0.exe --container updates --name updates/DJBookingSystem-1.2.0.exe
```

4. **Users Automatically Updated:**
- Within 1 hour, all running apps check for updates
- Find new version
- **Forced download begins immediately**
- No cancel option
- App installs and restarts automatically

---

## ? Update Schedule Details

### **How Hourly Checks Work:**

```csharp
// Calculate time until next hour
var now = DateTime.Now;
var nextHour = now.Date.AddHours(now.Hour + 1);
var timeUntilNextHour = nextHour - now;

// Example: Current time 10:37 AM
// Next check: 11:00 AM (23 minutes)
// Then: 12:00 PM, 1:00 PM, 2:00 PM, etc.
```

### **Check Times:**
```
10:00 AM ? Check for updates
11:00 AM ? Check for updates
12:00 PM ? Check for updates
1:00 PM ? Check for updates
...every hour on the hour...
```

### **What Happens When Update Found:**

```
[10:00 AM] Check triggered
   ?
[10:00:01] Update detected: v1.2.0
   ?
[10:00:02] UpdateNotificationDialog appears
   ?
[10:00:04] Forced download begins (2 sec delay)
   ?
[10:00:30] Download complete (varies by size)
   ?
[10:00:31] Signature verification
   ?
[10:00:32] Installation begins
   ?
[10:00:35] App restarts with v1.2.0
```

---

## ?? Security Features

### **1. HTTPS Only**
All connections use TLS 1.2/1.3

### **2. Certificate Pinning**
Validates server identity

### **3. Signature Verification**
Verifies installer authenticity

### **4. Secure Download**
Progress tracking with integrity checks

---

## ?? Testing Your Setup

### **Test Update Check:**

1. **Trigger Manual Check:**
```csharp
await UpdateManager.CheckForUpdatesOnStartupAsync(showNotifications: true, forceDownload: true);
```

2. **Check Debug Output:**
```
[2025-01-15 10:00:00] Hourly update check triggered
Checking for updates on startup (secure connection)...
Update available: 1.2.0
Security Status: ? Secure connection | ? Certificate pinned
Force Download: True
[UpdateDialog] FORCED DOWNLOAD MODE - No cancel options available
[UpdateDialog] Starting automatic forced download...
```

3. **Verify Behavior:**
- ? Dialog appears
- ? No cancel/close buttons
- ? Download starts automatically
- ? Progress bar shows
- ? Installs without prompts

---

## ?? Quick Reference

### **Server Files:**
```
/
??? version.json          (Update metadata)
??? updates/
    ??? DJBookingSystem-1.0.0.exe
    ??? DJBookingSystem-1.1.0.exe
    ??? DJBookingSystem-1.2.0.exe
```

### **version.json Template:**
```json
{
  "updateAvailable": true,
  "latestVersion": "1.2.0",
  "releaseDate": "2025-01-15T10:00:00Z",
  "downloadUrl": "YOUR_SERVER/updates/DJBookingSystem-1.2.0.exe",
  "releaseNotes": "Update description",
  "features": ["Feature 1", "Feature 2"],
  "bugFixes": ["Fix 1", "Fix 2"],
  "isCritical": true,
  "minimumVersion": "1.0.0"
}
```

### **Client Configuration:**
```csharp
// In Services\SecureUpdateClient.cs
private const string UPDATE_SERVER_URL = "YOUR_SERVER_URL";
private const string UPDATE_CHECK_ENDPOINT = "/version.json";
```

---

## ?? Summary

### ? **What's Implemented:**
- ? Hourly update checks (on the hour)
- ? Forced automatic downloads
- ? No cancel/close options
- ? Automatic installation
- ? Secure HTTPS connections
- ? Certificate pinning framework
- ? Signature verification

### ?? **What You Need to Do:**
1. ?? Choose hosting service (GitHub/AWS/Azure)
2. ?? Upload version.json and installer
3. ?? Update UPDATE_SERVER_URL in client
4. ?? Get SSL certificate fingerprints
5. ?? Test with dummy update

### ?? **Recommended Setup:**
- **Hosting**: GitHub Pages (free, easy)
- **Fallback**: SFTP server (already configured)
- **Security**: Add real SSL fingerprints
- **Testing**: Deploy test update first

---

## ?? Need Help?

Common issues and solutions:

| Issue | Solution |
|-------|----------|
| 404 errors | Check file paths and URLs |
| Certificate errors | Update TRUSTED_FINGERPRINTS |
| Download fails | Check file permissions (public access) |
| No updates detected | Verify version.json format |

**Status**: ?? **Client Ready - Just Need Server Setup!**
