# üîß Cosmos DB Troubleshooting Guide

## Common Issues and Solutions

### Issue 1: "The remote certificate is invalid"
**Cause**: SSL/TLS certificate validation issue
**Solution**:
```csharp
// This is already handled by the Cosmos SDK, but if you see this error:
// Check your system date/time is correct
// Ensure .NET 8 runtime is up to date
```

### Issue 2: "Request rate is large" (429 error)
**Cause**: Exceeded RU/s limit (400 RU/s in your case)
**Solution**:
- This shouldn't happen with normal use
- If it does, add retry logic (already in Cosmos SDK)
- Consider increasing throughput in Azure Portal

### Issue 3: "Unauthorized" (401 error)
**Cause**: Invalid account key or endpoint
**Solution**:
1. Go to Azure Portal
2. Navigate to your Cosmos DB account "fallen-collective"
3. Click "Keys" in left menu
4. Copy the PRIMARY KEY
5. Update in App.xaml.cs if different

### Issue 4: "Forbidden" (403 error)
**Cause**: Firewall rules blocking your IP
**Solution**:
1. Azure Portal ‚Üí Cosmos DB ‚Üí Networking
2. Add your IP to allowed list
3. OR enable "Allow access from Azure Portal"

### Issue 5: "Container already exists with different partition key"
**Cause**: Containers were created with old partition keys
**Solution**:
1. Go to Azure Portal ‚Üí Data Explorer
2. Delete each container:
   - Users
   - Bookings
   - Venues
   - Chat
   - Settings
   - RadioStations
   - Reports
3. Run your app again to recreate with correct partition keys

### Issue 6: Application won't build
**Cause**: Missing NuGet packages
**Solution**:
```powershell
# In Visual Studio Package Manager Console:
Update-Package Microsoft.Azure.Cosmos
Restore-Package
```

### Issue 7: "Database does not exist"
**Cause**: Initialization hasn't run yet
**Solution**:
- This is normal on first run
- The `InitializeDatabaseAsync` method creates it
- Just let the app run

## üß™ Testing Your Setup

### Quick Connection Test
Add this method to test connection without running full app:

```csharp
public static async Task TestConnectionAsync()
{
    try
    {
        string endpoint = "https://fallen-collective.documents.azure.com:443/";
        string accountKey = "YOUR_KEY_HERE";
        string connectionString = $"AccountEndpoint={endpoint};AccountKey={accountKey};";
        
        var cosmosClient = new CosmosClient(connectionString);
        var response = await cosmosClient.ReadAccountAsync();
        
        Console.WriteLine("‚úÖ Connection successful!");
        Console.WriteLine($"Account: {response.Resource.Id}");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"‚ùå Connection failed: {ex.Message}");
    }
}
```

## üìä Monitoring Your Database

### Check RU Usage
1. Azure Portal ‚Üí Cosmos DB ‚Üí Metrics
2. Look at "Normalized RU Consumption"
3. Should stay under 100% for free tier

### Check Container Status
1. Azure Portal ‚Üí Data Explorer
2. Expand "DJBookingDB"
3. See all 7 containers
4. Click each to view partition key

### View Data
1. Azure Portal ‚Üí Data Explorer
2. Select container ‚Üí Items
3. Browse documents
4. Run queries

## üîê Security Best Practices

### DO:
‚úÖ Keep connection strings in secure config
‚úÖ Use Azure Key Vault in production
‚úÖ Regenerate keys periodically
‚úÖ Use read-only keys where possible

### DON'T:
‚ùå Commit keys to source control (already in .gitignore)
‚ùå Share keys in chat/email
‚ùå Use same keys across environments
‚ùå Hardcode keys in production

## üí∞ Cost Management

### Free Tier Limits:
- 1000 RU/s total
- 25 GB storage
- First 1000 RU/s free forever

### Your Setup:
- 400 RU/s shared (well within free tier!)
- Containers share throughput
- Cost: $0/month (free tier)

### If You Exceed:
- Add more RU/s in Azure Portal
- Cost: ~$0.008 per RU/s per hour
- 400 RU/s = ~$23/month (if not free tier)

## üìû Getting Help

### Error Messages
- Copy the full error message
- Include stack trace
- Note what operation you were doing

### Logs
Check debug output in Visual Studio:
- Debug ‚Üí Windows ‚Üí Output
- Look for "System.Diagnostics.Debug.WriteLine" messages

### Azure Support
- Azure Portal ‚Üí Support ‚Üí New Support Request
- Community: Microsoft Q&A, Stack Overflow

## ‚úÖ Verification Checklist

After setup, verify:
- [ ] App builds without errors
- [ ] Connection to Cosmos DB successful
- [ ] Database "DJBookingDB" created
- [ ] All 7 containers exist with correct partition keys
- [ ] Default admin user created
- [ ] Can log in successfully
- [ ] Can create a venue
- [ ] Can create a booking
- [ ] Data persists after restart

## üéØ Performance Tips

1. **Use the right partition key in queries**
   ```csharp
   // GOOD: Query within partition
   var query = new QueryDefinition(
       "SELECT * FROM c WHERE c.Username = @username")
       .WithParameter("@username", "SysAdmin");
   
   // BAD: Cross-partition query
   var query = new QueryDefinition("SELECT * FROM c");
   ```

2. **Batch operations when possible**
   ```csharp
   // Create multiple items in one request (same partition)
   var batch = container.CreateTransactionalBatch(
       new PartitionKey("VenueName"));
   batch.CreateItem(booking1);
   batch.CreateItem(booking2);
   await batch.ExecuteAsync();
   ```

3. **Use pagination for large results**
   ```csharp
   // Already implemented in your GetAll methods!
   while (query.HasMoreResults)
   {
       var response = await query.ReadNextAsync();
       // Process batch
   }
   ```

---

**Need help?** Just ask! I'm here to support you through this.
