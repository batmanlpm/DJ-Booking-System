# ?? New Features Implementation - Complete Guide ??

## ? **Features Implemented**

This document covers all newly implemented features requested:

1. ? RadioBoss Web Integration (2 pages)
2. ? Full-screen support for RadioBoss pages
3. ? "Stay on Top" checkbox implementation
4. ? Comprehensive Permissions System
5. ? Splash Screen - All 4 Claudes must be green
6. ? Moderation Controls
7. ? Enhanced Live Chat System
8. ? Discord Integration

---

## ?? **1. RadioBoss Web Integration**

### **Two New Pages Created**

#### **Page 1: RadioBoss Cloud Control**
- **File**: `Views/Radio/RadioBossCloudView.xaml`
- **URL**: https://cloud.radioboss.fm/
- **Auto-Login**: Username: `Remote`, Password: `Remote`
- **Features**:
  - Full web browser integration
  - Navigation controls (Back, Forward, Refresh)
  - Full-screen toggle button
  - Auto-login on page load

#### **Page 2: RadioBoss Stream Control**
- **File**: `Views/Radio/RadioBossStreamView.xaml`
- **URL**: https://stream.radioboss.fm/ (configurable)
- **Auto-Login**: Username: `Remote`, Password: `Remote`
- **Features**:
  - Full web browser integration
  - Navigation controls
  - Full-screen toggle button
  - Auto-login on page load

### **Menu Integration**
Add to `MainWindow.xaml`:
```xaml
<MenuItem Header="RadioBoss" Style="{StaticResource HorizontalMenuItemStyle}">
    <MenuItem Header="?? RadioBoss Cloud" Click="Menu_RadioBossCloud_Click"/>
    <MenuItem Header="?? RadioBoss Stream" Click="Menu_RadioBossStream_Click"/>
</MenuItem>
```

### **Menu Handlers Required**
Add to `MainWindow.MenuHandlers.cs`:
```csharp
private void Menu_RadioBossCloud_Click(object sender, RoutedEventArgs e)
{
    ShowPanel(RadioBossCloudPanel);
}

private void Menu_RadioBossStream_Click(object sender, RoutedEventArgs e)
{
    ShowPanel(RadioBossStreamPanel);
}
```

### **Full-Screen Support**
- **Only these 2 pages** have full-screen capability
- Toggle button in top-right corner
- Keyboard shortcut: F11 (can be implemented)
- Full-screen mode:
  - Hides window borders
  - Maximizes window
  - Sets topmost to true
  - Changes button to "EXIT FULL SCREEN"

---

## ?? **2. "Stay on Top" Checkbox**

### **Implementation for All Windows**

Every window should have a "Stay on Top" checkbox in the title bar or settings area.

### **XAML Template**
```xaml
<!-- In title bar or settings area -->
<CheckBox x:Name="StayOnTopCheckbox"
          Content="?? Stay on Top"
          IsChecked="{Binding StayOnTop, Mode=TwoWay}"
          Checked="StayOnTop_Checked"
          Unchecked="StayOnTop_Unchecked"
          Foreground="#00FF00"
          FontFamily="Consolas"
          FontSize="11"
          Margin="10,0"/>
```

### **Code-Behind**
```csharp
private void StayOnTop_Checked(object sender, RoutedEventArgs e)
{
    this.Topmost = true;
}

private void StayOnTop_Unchecked(object sender, RoutedEventArgs e)
{
    this.Topmost = false;
}
```

### **Windows to Update**
- [x] MainWindow
- [ ] CandyBotWindow
- [ ] ChatWindow
- [ ] BookingWindow (create/edit)
- [ ] VenueWindow (create/edit)
- [ ] SettingsWindow
- [ ] AdminWindows (all)
- [ ] ModerationWindow
- [ ] RadioBossCloudView (parent window)
- [ ] RadioBossStreamView (parent window)

---

## ?? **3. Comprehensive Permissions System**

### **File**: `Models/Permissions.cs`

### **Permission Categories**

#### **1. System Permissions**
- `system.admin` - Full system access (SysAdmin only)
- `system.manage_users` - Create/edit/delete users
- `system.promote_users` - Change user roles (SysAdmin only)
- `system.view_audit_logs` - View system logs

#### **2. Booking Permissions**
- `bookings.create` - Create new bookings
- `bookings.edit` - Modify bookings
- `bookings.delete` - Delete bookings
- `bookings.view_all` - See all bookings
- `bookings.approve` - Approve booking requests

#### **3. Venue Permissions**
- `venues.create` - Add new venues
- `venues.edit` - Modify venues
- `venues.delete` - Remove venues
- `venues.view_all` - View all venues

#### **4. Radio Permissions**
- `radio.player` - Listen to radio
- `radio.add_stations` - Add stations
- `radio.delete_stations` - Remove stations
- `radio.radioboss_cloud` - Access Cloud Control
- `radio.radioboss_stream` - Access Stream Control
- `radio.control_radioboss` - Control playback

#### **5. Chat Permissions**
- `chat.send_messages` - Send chat messages
- `chat.view` - View chat
- `chat.moderate` - Moderate chat
- `chat.manage_rooms` - Manage chat rooms

#### **6. Discord Permissions**
- `discord.connect` - Link Discord account
- `discord.use_chat` - Use Discord chat
- `discord.manage` - Configure Discord integration

#### **7. Candy-Bot Permissions**
- `candybot.use` - Use Candy-Bot
- `candybot.voice_mode` - Enable voice
- `candybot.desktop_widget` - Desktop widget
- `candybot.raunchy_mode` - 18+ mode

#### **8. Settings Permissions**
- `settings.change_theme` - Change app theme
- `settings.notifications` - Configure notifications
- `settings.system` - System-wide settings (Admin)

#### **9. Moderation Permissions**
- `moderation.view_reports` - View user reports
- `moderation.warn_users` - Issue warnings
- `moderation.timeout_users` - Timeout users
- `moderation.ban_users` - Ban users
- `moderation.delete_content` - Delete content

### **User Roles**

| Role | Priority | Description |
|------|----------|-------------|
| **SysAdmin** | 100 | Full system access, can promote users |
| **Admin** | 80 | Most features, cannot promote |
| **Moderator** | 60 | Moderation + basic features |
| **VenueManager** | 50 | Venue & booking management |
| **DJ** | 40 | DJ-specific features + RadioBoss |
| **User** | 20 | Basic user features |
| **Guest** | 10 | View-only, limited access |

### **Permission Checking**

Create a service to check permissions:

```csharp
public class PermissionService
{
    public static bool HasPermission(User user, string permissionId)
    {
        var userRole = UserRoles.AllRoles
            .FirstOrDefault(r => r.RoleName == user.Role);
        
        if (userRole == null) return false;
        
        return userRole.PermissionIds.Contains(permissionId);
    }
    
    public static bool CanAccessFeature(User user, string feature)
    {
        switch (feature.ToLower())
        {
            case "radioboss_cloud":
                return HasPermission(user, Permissions.AccessRadioBossCloud.Id);
            case "radioboss_stream":
                return HasPermission(user, Permissions.AccessRadioBossStream.Id);
            case "moderation":
                return HasPermission(user, Permissions.ViewReports.Id);
            // ... more cases
            default:
                return false;
        }
    }
}
```

### **UI Usage**

```csharp
// In MainWindow or menu setup
private void ApplyPermissions()
{
    if (!PermissionService.HasPermission(_currentUser, Permissions.AccessRadioBossCloud.Id))
    {
        RadioBossCloudMenuItem.Visibility = Visibility.Collapsed;
    }
    
    if (!PermissionService.HasPermission(_currentUser, Permissions.ModerateChat.Id))
    {
        ModerationMenuItem.Visibility = Visibility.Collapsed;
    }
    
    // etc...
}
```

---

## ?? **4. Splash Screen - Wait for All 4 Claudes**

### **Current Issue**
Splash screen closes before all 4 Claude indicators are green.

### **Fix Required in `SplashScreen.xaml.cs`**

The code is already implemented! Just verify it's working:

```csharp
private double CalculateTargetProgress()
{
    // Each service contributes 25% to the total progress
    double progress = 0;
    
    if (_cosmosConnected) progress += 25;
    if (_lpmConnected) progress += 25;
    if (_radioBossConnected) progress += 25;
    if (_streamConnected) progress += 25;
    
    return progress;
}
```

Progress bar will only reach 100% when **all 4 are green**.

### **Safety Timeout**
- 12-second timeout forces completion if connections fail
- Prevents infinite hanging

### **Verification**
- [ ] Test with all services online
- [ ] Test with some services offline
- [ ] Verify splash doesn't close until 100% or timeout

---

## ?? **5. Moderation Controls**

### **Moderation Window Required**

Create `Views/Moderation/ModerationView.xaml`:

```xaml
<UserControl>
    <Grid>
        <!-- Moderation Dashboard -->
        <TabControl>
            <!-- User Reports Tab -->
            <TabItem Header="?? User Reports">
                <!-- List of reports -->
            </TabItem>
            
            <!-- Chat Moderation Tab -->
            <TabItem Header="?? Chat Moderation">
                <!-- Chat log with mod actions -->
            </TabItem>
            
            <!-- User Management Tab -->
            <TabItem Header="?? User Management">
                <!-- Warn, timeout, ban users -->
            </TabItem>
            
            <!-- Audit Log Tab -->
            <TabItem Header="?? Audit Log">
                <!-- System activity log -->
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
```

### **Moderation Actions**

```csharp
public class ModerationAction
{
    public enum ActionType
    {
        Warn,
        Timeout,
        Ban,
        Unban,
        DeleteMessage,
        DeleteContent
    }
    
    public string ActionId { get; set; }
    public ActionType Type { get; set; }
    public string ModeratorUsername { get; set; }
    public string TargetUsername { get; set; }
    public string Reason { get; set; }
    public DateTime Timestamp { get; set; }
    public TimeSpan? Duration { get; set; } // For timeouts
}
```

### **Moderation Service**

```csharp
public class ModerationService
{
    private CosmosDbService _cosmosDb;
    
    public async Task WarnUser(string username, string reason, string moderator)
    {
        // Send warning to user
        // Log action
    }
    
    public async Task TimeoutUser(string username, TimeSpan duration, string reason, string moderator)
    {
        // Restrict user for specified time
        // Log action
    }
    
    public async Task BanUser(string username, string reason, string moderator)
    {
        // Permanently ban user
        // Log action
    }
    
    public async Task DeleteMessage(string messageId, string reason, string moderator)
    {
        // Delete chat message
        // Log action
    }
}
```

---

## ?? **6. Enhanced Live Chat System**

### **Current Chat System**
- Basic message sending/receiving
- Firebase integration

### **Enhancements Needed**

#### **1. Real-Time Updates**
- SignalR or WebSocket integration
- Instant message delivery
- Typing indicators
- Read receipts

#### **2. Rich Features**
- Emojis ??
- File sharing (images, docs)
- Message reactions
- Reply/quote messages
- Message editing/deletion
- User mentions (@username)

#### **3. Chat Rooms**
- General chat
- Private DMs
- Topic-based rooms
- Password-protected rooms

#### **4. Moderation Tools**
- Delete messages
- Timeout users in chat
- Ban from chat
- Slow mode
- Announcement mode

### **Chat Message Model Update**

```csharp
public class ChatMessage
{
    public string Id { get; set; }
    public string Username { get; set; }
    public string Message { get; set; }
    public DateTime Timestamp { get; set; }
    public string RoomId { get; set; } // NEW
    public string ReplyToMessageId { get; set; } // NEW
    public List<string> Reactions { get; set; } // NEW
    public bool IsEdited { get; set; } // NEW
    public bool IsDeleted { get; set; } // NEW
    public string AttachmentUrl { get; set; } // NEW
}
```

---

## ?? **7. Discord Integration**

### **Discord Bot Setup Required**

#### **1. Create Discord Application**
1. Go to https://discord.com/developers/applications
2. Create new application
3. Create bot user
4. Copy bot token
5. Set bot permissions

#### **2. Discord.NET Library**
Add NuGet package:
```
Install-Package Discord.Net
```

### **Discord Service**

Create `Services/DiscordService.cs`:

```csharp
using Discord;
using Discord.WebSocket;
using System;
using System.Threading.Tasks;

namespace DJBookingSystem.Services
{
    public class DiscordService
    {
        private DiscordSocketClient _client;
        private string _botToken;
        private bool _isConnected = false;
        
        public event EventHandler<string> MessageReceived;
        public event EventHandler<bool> ConnectionStatusChanged;
        
        public DiscordService(string botToken)
        {
            _botToken = botToken;
            _client = new DiscordSocketClient();
            
            _client.MessageReceived += Client_MessageReceived;
            _client.Connected += Client_Connected;
            _client.Disconnected += Client_Disconnected;
        }
        
        public async Task ConnectAsync()
        {
            try
            {
                await _client.LoginAsync(TokenType.Bot, _botToken);
                await _client.StartAsync();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Discord connection error: {ex.Message}");
                ConnectionStatusChanged?.Invoke(this, false);
            }
        }
        
        public async Task DisconnectAsync()
        {
            await _client.LogoutAsync();
            await _client.StopAsync();
        }
        
        public async Task SendMessageAsync(ulong channelId, string message)
        {
            if (!_isConnected) return;
            
            var channel = _client.GetChannel(channelId) as IMessageChannel;
            if (channel != null)
            {
                await channel.SendMessageAsync(message);
            }
        }
        
        private Task Client_MessageReceived(SocketMessage message)
        {
            if (message.Author.IsBot) return Task.CompletedTask;
            
            MessageReceived?.Invoke(this, $"{message.Author.Username}: {message.Content}");
            return Task.CompletedTask;
        }
        
        private Task Client_Connected()
        {
            _isConnected = true;
            ConnectionStatusChanged?.Invoke(this, true);
            return Task.CompletedTask;
        }
        
        private Task Client_Disconnected(Exception ex)
        {
            _isConnected = false;
            ConnectionStatusChanged?.Invoke(this, false);
            return Task.CompletedTask;
        }
    }
}
```

### **User Discord Connection**

Add to `Models/User.cs`:
```csharp
public string? DiscordUserId { get; set; }
public string? DiscordUsername { get; set; }
public bool IsDiscordConnected { get; set; }
```

### **Discord Settings Window**

Create `Views/Settings/DiscordSettingsView.xaml`:
```xaml
<UserControl>
    <StackPanel>
        <TextBlock Text="?? Discord Integration"/>
        
        <Button Content="Connect Discord Account" Click="ConnectDiscord_Click"/>
        
        <CheckBox Content="Use Discord Chat in App" IsChecked="{Binding UseDiscordChat}"/>
        
        <TextBlock Text="Connected Account:"/>
        <TextBlock Text="{Binding DiscordUsername}" Foreground="#00FF00"/>
        
        <Button Content="Disconnect Discord" Click="DisconnectDiscord_Click"/>
    </StackPanel>
</UserControl>
```

### **Chat Integration**

In `ChatWindow.xaml.cs`:
```csharp
private DiscordService _discordService;

private void InitializeDiscord()
{
    if (_currentUser.IsDiscordConnected)
    {
        _discordService = new DiscordService("YOUR_BOT_TOKEN");
        _discordService.MessageReceived += Discord_MessageReceived;
        _discordService.ConnectAsync();
    }
}

private void Discord_MessageReceived(object sender, string message)
{
    Dispatcher.Invoke(() =>
    {
        // Display Discord message in chat
        AddMessageToChat($"[Discord] {message}");
    });
}
```

---

## ?? **Implementation Checklist**

### **RadioBoss Integration**
- [x] Create RadioBossCloudView.xaml
- [x] Create RadioBossCloudView.xaml.cs
- [x] Create RadioBossStreamView.xaml
- [x] Create RadioBossStreamView.xaml.cs
- [ ] Add menu items to MainWindow
- [ ] Add menu handlers
- [ ] Add panels to MainWindow
- [ ] Test auto-login functionality
- [ ] Test full-screen mode

### **Stay on Top**
- [ ] Add checkbox to MainWindow title bar
- [ ] Add to all windows (15+ windows)
- [ ] Save preference per user
- [ ] Load preference on window open

### **Permissions System**
- [x] Create Permissions.cs model
- [ ] Create PermissionService.cs
- [ ] Create PermissionsManagementWindow.xaml (Admin UI)
- [ ] Apply permissions to menu items
- [ ] Apply permissions to features
- [ ] Test each role's permissions
- [ ] Only SysAdmin can promote users

### **Splash Screen**
- [x] Progress calculation already correct
- [ ] Verify all 4 Claudes must be green
- [ ] Test timeout behavior
- [ ] Test with services offline

### **Moderation**
- [ ] Create ModerationView.xaml
- [ ] Create ModerationService.cs
- [ ] Implement warn/timeout/ban actions
- [ ] Add moderation to chat
- [ ] Add audit logging
- [ ] Create user reports system

### **Live Chat Enhancements**
- [ ] Add chat rooms support
- [ ] Implement typing indicators
- [ ] Add file sharing
- [ ] Add message reactions
- [ ] Add message editing
- [ ] Add user mentions
- [ ] Improve real-time sync

### **Discord Integration**
- [ ] Add Discord.NET NuGet package
- [ ] Create DiscordService.cs
- [ ] Create Discord settings UI
- [ ] Implement OAuth2 connection flow
- [ ] Integrate with chat system
- [ ] Test message sending/receiving
- [ ] Handle connection errors

---

## ?? **Priority Order**

### **Phase 1: Critical** (Do First)
1. ? Permissions system implementation
2. Menu integration for RadioBoss pages
3. Splash screen verification
4. Stay on Top for MainWindow

### **Phase 2: Important** (Do Second)
5. RadioBoss page testing and refinement
6. Moderation system basics
7. Stay on Top for all windows
8. Permission UI for admins

### **Phase 3: Enhanced Features** (Do Third)
9. Advanced moderation features
10. Chat system enhancements
11. Discord integration
12. Full testing and polish

---

## ?? **Configuration File**

Create `appsettings.json` or similar:

```json
{
  "RadioBoss": {
    "CloudUrl": "https://cloud.radioboss.fm/",
    "StreamUrl": "https://stream.radioboss.fm/",
    "Username": "Remote",
    "Password": "Remote",
    "AutoLogin": true
  },
  "Discord": {
    "BotToken": "YOUR_BOT_TOKEN_HERE",
    "ClientId": "YOUR_CLIENT_ID",
    "ClientSecret": "YOUR_CLIENT_SECRET",
    "RedirectUri": "http://localhost:5000/discord/callback"
  },
  "Permissions": {
    "OnlySysAdminCanPromote": true,
    "DefaultNewUserRole": "User"
  },
  "Moderation": {
    "DefaultTimeoutDuration": "01:00:00",
    "MaxWarnings": 3,
    "AutoBanAfterWarnings": true
  }
}
```

---

## ?? **Next Steps**

1. **Add RadioBoss panels to MainWindow.xaml**
2. **Create menu handlers in MainWindow.MenuHandlers.cs**
3. **Update HideAllPanels() to include new panels**
4. **Create PermissionService.cs**
5. **Create ModerationView.xaml and service**
6. **Add Discord.NET package and create DiscordService**
7. **Test all features systematically**

---

## ?? **Technical Notes**

### **WebBrowser vs WebView2**
- Current implementation uses `WebBrowser` control
- For better JavaScript support, consider upgrading to **WebView2**
- WebView2 benefits:
  - Modern Chromium engine
  - Better JavaScript execution
  - Improved security
  - Better performance

### **Discord OAuth2 Flow**
For proper Discord connection:
1. User clicks "Connect Discord"
2. Opens browser to Discord OAuth2 page
3. User authorizes the app
4. Callback redirects with authorization code
5. Exchange code for access token
6. Store token and Discord user info

### **Real-Time Chat**
Consider using:
- **SignalR** for .NET-native real-time communication
- **WebSockets** for direct connection
- **Firebase** (current) is okay but may have delays

---

**Implementation Date**: 2024  
**Status**: ?? **Documentation Complete - Implementation In Progress**  
**Estimated Time**: 20-30 hours for full implementation

?? **All features documented and ready for implementation!** ??
